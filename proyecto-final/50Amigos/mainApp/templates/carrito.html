{% extends 'fragments/base.html' %}

{% block title %}Carrito{% endblock %}







{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a
        class="text-decoration-none"
        href="{% url 'mainApp:inicio' %}">Inicio</a>
      </li>
    <li class="breadcrumb-item">
      <a
        class="text-decoration-none"
        href="{% url 'mainApp:menu' %}">Menú</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Carrito</li>
  </ol>
</nav>
<br>
<h1>Carrito</h1>
<hr>
<p class="my-3">
  Estos productos se encuentran actualmente en tu carrito, puedes
  editarlos aún o removerlos antes de hacer el pedido apretando el
  botón <b>Hacer pedido</b>.
</p>
<table class="table table-sm table-striped my-5">
  <thead>
    <tr>
      <th scope="col" class="text-center">#</th>
      <th scope="col" class="text-center">Producto</th>
      <th scope="col" class="text-center">Precio</th>
      <th scope="col" class="text-center">Subtotal</th>
      <th scope="col" class="text-center">
        <i class="bi bi-dash"></i>
      </th>
      <th scope="col" class="text-center">Cantidad</th>
      <th scope="col" class="text-center">
        <i class="bi bi-plus"></i>
      </th>
      <th scope="col" class="text-center">Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for pedido in carrito.pedidos.all %}
    <tr>
      <th scope="row" class="text-center px-3">
        {{ pedido.platillo.id }}
      </th>
      <td class="text-center">
        {{ pedido.platillo.nombre }}
      </td>
      <td class="text-center">
        $ {{ pedido.platillo.precio }}
      </td>
      <td class="text-center">
        $ {{ pedido.get_subtotal }}
      </td>
      <td class="text-center">
        <button
          type="button"
          onclick="disminuirCantidad({{ pedido.platillo.id }})"
          class="btn btn-link btn-sm">
          <i class="bi bi-dash"></i>
        </button>
      </td>
      <td class="text-center" id="counter{{pedido.platillo.id}}">
        <b> {{ pedido.cantidad }}</b>
      </td>
      <td class="text-center">
        <button
          type="button"
          onclick="aumentarCantidad({{ pedido.platillo.id }})"
          class="btn btn-sm btn-link ">
          <i class="bi bi-plus"></i>
        </button>
      </td>
      <td class="text-center">
        <button
          type="button"
          onclick="eliminarPlatillo({{ pedido.platillo.id }})"
          class="btn btn-sm btn-link">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="float-end">
<span class="h5 float-end">
  Total: &nbsp;&nbsp;$ {{ carrito.get_total }}
</span>
<br>
<br>
<form method="POST" action="{% url 'mainApp:carrito' %}">
  <div style="display:none">
    <input
      type="hidden"
      name="csrfmiddlewaretoken"
      value="{{ csrf_token }}" />
  </div>
  <button
    type="submit"
    class="btn btn-primary float-end">
    <i class="bi bi-cart"></i> Hacer pedido
  </button>
</form>
<br>
<br>
</div>
<br>
<br>
<br>
<br>
<br>
<h1>Historial de pedidos</h1>
<hr>
<p class="my-3">
Estos son los pedidos que se han hecho durante su estadía en el restaurante,
las tarifas con impuestos se muestran al final. Se agradece su propina.
</p>
<table class="table table-sm table-striped my-5">
  <thead>
    <tr>
      <th scope="col" class="text-center">#</th>
      <th scope="col" class="text-center">Producto</th>
      <th scope="col" class="text-center">Cantidad</th>
      <th scope="col" class="text-center">Precio</th>
      <th scope="col" class="text-center">Subtotal</th>
    </tr>
  </thead>
  <tbody>
    {% for pedido in orden.get_pedidos %}
    <tr>
      <th scope="row" class="text-center">{{ pedido.id }}</th>
      <td class="text-center">{{ pedido.platillo.nombre }}</td>
      <td class="text-center"><b>{{ pedido.cantidad }}</b></td>
      <td class="text-center"><b>$</b> {{ pedido.platillo.precio }}</td>
      <td class="text-center"><b>$</b> {{ pedido.get_subtotal }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="float-end">
  <span class="h5 float-end">
    Total: &nbsp;&nbsp;$ {{ orden.get_total }}
  </span>
  <br>
  <br>
  <form method="POST" action="{% url 'mainApp:orden' %}" >
    <div style="display:none">
      <input
        type="hidden"
        name="csrfmiddlewaretoken"
        value="{{ csrf_token }}" />
    </div>
    <button
      type="submit"
      class="btn btn-primary">
      <i class="bi bi-currency-dollar"></i> Solicitar cuenta
    </button>
  </form>
</div>
<br>
<br>
<br>
<br>
<br>

{% endblock %}







{% block scripts %}
<script type="text/javascript">

/**
 * Función que decrementa en uno la cantidad de elementos a agregar
 * al carrito del platillo especificado.
 *
 * @param {number} identificador del platillo.
*/
function disminuirCantidad(platilloId) {
  let count = parseInt($('#counter' + platilloId).text());
  if (count > 1) {
    $('#global-spinner').show();
    $.ajax("{% url 'mainApp:carrito' %}", {
      type: 'PUT',
      data: {
        platillo: parseInt(platilloId),
        cantidad: count - 1
      },
      success: function (res) {
        location.reload();
      },
      error: function (err) {
        $('#global-spinner').hide();
        console.error(err);
      }
    });
  }
}

/**
 * Función que incrementa en uno la cantidad de elementos a agregar
 * al carrito del platillo especificado.
 *
 * @param {number} identificador del platillo.
*/
function aumentarCantidad(platilloId) {
  $('#global-spinner').show();
  let count = parseInt($('#counter' + platilloId).text());
  $.ajax("{% url 'mainApp:carrito' %}", {
    type: 'PUT',
    data: {
      platillo: parseInt(platilloId),
      cantidad: count + 1
    },
    success: function (res) {
      location.reload();
    },
    error: function (err) {
      $('#global-spinner').hide();
      console.error(err);
    }
  });
}

/**
 * Función que elimina todas las ocurrencias de un platillo del carrito.
 *
 * @param {number} identificador del platillo.
*/
function eliminarPlatillo(platilloId) {
  $('#global-spinner').show();
  $.ajax("{% url 'mainApp:carrito' %}", {
    type: 'DELETE',
    data: {
      platillo: parseInt(platilloId)
    },
    success: function (res) {
      location.reload();
    },
    error: function (err) {
      $('#global-spinner').hide();
      console.error(err);
    }
  });
}


</script>
{% endblock %}
