{% extends 'fragments/base.html' %}
{% load static %}

{% block title %}Votación{% endblock %}





{# Usando modal de manera global, para que empate con AnimateCSS #}
{% block modal_header %}
  <h5 
    class="modal-title animate__animated animate__headShake" 
    id="tituloModal">
    Persona 1
  </h5>
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="modal"
    aria-label="Close"></button>
{% endblock %}

{% block modal_body %}
  <img
    id="heladoImg"
    class="animate__animated animate__headShake text-center" 
    src="{% static 'img/helados.jpg' %}" 
    alt="helado"
    width="100%">
  <div class="form-group">
    <label for="nombreInput">¿Cuál es su nombre?</label>
    <input
    id="nombreInput"
    onkeyup="actualizarNombreModal()"
    type="text"
    class="form-control"
    placeholder="Juan"/>
    <br>
  </div>
  <div class="form-group">
    <label for="heladoSelect">
      ¿Qué helado vota por servir al final?
    </label>
    <select class="form-select" id ="heladoSelect"></select>
  </div>
{% endblock %}

{% block modal_footer %}
  <button 
    onclick="agregarParticipante()"
    type="button" 
    class="btn btn-outline-secondary">Agregar otro participante</button>
  <button 
    onclick="finalizarVotacion()"
    type="button" 
    class="btn btn-outline-primary"
    data-bs-dismiss="modal">Finalizar votación</button>
{% endblock %}








{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a
        class="text-decoration-none"
        href="{% url 'mainApp:inicio' %}">Inicio</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Helado</li>
  </ol>
</nav>
<br>
<h1>Helado</h1>
<hr>
<p>Inicia la votación para el sabor de helado!</p>
<br>
<button
  class="btn btn-outline-primary"
  data-bs-toggle="modal"
  data-bs-target="#globalModal">
  Votar!
</button>
<br>
<br>
<div id="resultados" class="text-center" style="display: none;">
    <canvas id="myChart"></canvas>
</div>
<br>
<br>
<br>
<br>
<br>
<div style="display:none">
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</div>
{% endblock %}








{% block scripts %}
<script src="{% static 'js/chart.js' %}"></script>
<script>

let helados = [1, 2, 3, 4];
let votos = [];
let curVotante = 1;

$(document).ready(function () {
  $('#tituloModal').html('Persona ' + curVotante);
  // $('#resultados').toggle(); // No se muestran al prinicipio

  $.ajax("{% url 'mainApp:lista_helados' %}", {
    method: 'GET',
    success: function(res) {
      cargarDatosHelados(res);
    },
    error: function (err) {
      console.error(err);
    }
  });
});

const ctx = document.getElementById('myChart');

// Definición de la gráfica de resultados de la votación
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Chocolate', 'Vainilla', 'Fresa', 'Limón'],
    datasets: [{
      label: '# de votos',
      data: [3, 2, 0, 1],
      backgroundColor: [
        'rgba(255, 99, 132, 0.2)',
        'rgba(255, 159, 64, 0.2)',
        'rgba(255, 205, 86, 0.2)',
        'rgba(75, 192, 192, 0.2)',
      ],
      borderColor: [
        'rgb(255, 99, 132)',
        'rgb(255, 159, 64)',
        'rgb(255, 205, 86)',
        'rgb(75, 192, 192)'
      ],
      borderWidth: 2
    }]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});

/**
 * función que carga el listado de los helados en las opciones del
 * dropdown de seleccion dentro de la ventana emergente.
 */
function cargarDatosHelados(helados) {
  let res = '';

  for (let i = 0; i < helados.length; i++) {
    res += `<option value="${helados[i].id}">${helados[i].nombre}</option>`;
  }

  $('#heladoSelect').html(res);
}

/**
 * Función que actualiza el titulo de la ventana emergente para que
 * tenga el nombre de la persona escrita en el cuadro de texto.
 */
function actualizarNombreModal() {
  let val = $('#nombreInput').val();
  $('#tituloModal').html(val);
}

/**
 * Función que agrega el voto de un participante y actualiza
 * el estado de la ventana emergente para cambiarle el titulo por la persona
 * dada.
 */
function agregarParticipante() {

  let votoActual = $('#heladoSelect').val();
  $('#heladoSelect').toggleClass('animate__headShake');
  votos.push(votoActual)
  $('#tituloModal').html("Persona " + (++curVotante));
  $('#nombreInput').val("");
  $('#tituloModal').toggleClass('animate__tada');
  $('#heladoImg').toggleClass('animate__tada');
}

/**
 * Función que manda los resultados de la votación para asignar el sabor
 * de helado a la orden actual del usuario.
 */
function finalizarVotacion() {
  $('#resultados').toggle();

  let heladoEscogido = -1;
  let helados = [];
  let freq = {};

  // Cuenta la ocurrencia de cada id
  for (let i = 0; i < helados.length; i++) {
    if (!freq[helados[i]]) {
      freq[helados[i]] = 1;
    } else {
      freq[helados[i]]++;
    }
  }

  // Escoge el primero que tenga el mayor numero de votaciones
  for (let i = 0; i < helados.length; i++) {
    if (freq[helados[i]] > heladoEscogido) {
      heladoEscogido = helados[i];
    }
  }

  $.ajax("{% url 'mainApp:votacion' %}", {
    method: 'POST',
    contentType: 'application/json',
    data: {
      helado: heladoEscogido
    },
    success: function (res) {
      location.reload();
    },
    error: function (err) {
      console.error(err);
    }
  });
}

/**
 * Función que contabiliza el voto de un comensal
 */
function addComensal(nombre, helado) {
  votos.push(helado);
}

</script>
{% endblock %}