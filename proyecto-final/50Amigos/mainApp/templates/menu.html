{% extends 'fragments/base.html' %}

{% block title %}Menú{% endblock %}
{%load static%}


{# Usando modal de manera global, para que empate con AnimateCSS #}
{% block modal_header %}
  <h5
    class="modal-title animate__animated animate__headShake"
    id="tituloModal">
    Persona 1
  </h5>
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="modal"
    aria-label="Close"></button>
{% endblock %}

{% block modal_body %}
<div>
  <img
    id="platilloImagen"
    class="animate__animated animate__headShake text-center"
    src="{% static 'img/helados.jpg' %}"
    alt="helado"
    width="100%" />

  <br>

  <br>
  <div class="float-end">
    <span class="h5">Precio: </span>
    <span
      id="platilloPrecio"
      class="h3">
      Precio
    </span>
  </div>

  <hr>
  <br>
  <h5>Descripción:</h6>
  <br>
  <p id="platilloDescripcion"></p>
  <br>

  <h5>Ingredientes:</h5><hr>
  <ul id="platilloIngredientes">
    <li class=""></li>
  </ul>
  <br>

  <!--  
  <h5>Alérgenos:</h5><hr>
  <ul id="platilloAlergenos">
    <li class=""></li>
  </ul>
  <br>
  -->

</div>
{% endblock %}







{% block content %}

<nav aria-label="breadcrumb" id="breadcrumb">
<ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a
      class="text-decoration-none"
      href="{% url 'mainApp:inicio' %}">Inicio</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">Menú</li>
</ol>
</nav>

<br>
<h1>Menú</h1>
<hr>

<div id="categorias">
{% for categoria in categorias %}
  <a
    href="#categoria-{{ categoria.id }}"
    class="badge badge-outline rounded-pill mt-2 text-decoration-none">
    <span class="fs-6">{{ categoria.nombre }}</span>
  </a>
{% endfor %}
</div>

<br>
<br>
<br>
<br>

{% for categoria in categorias %}
  <h2 id="categoria-{{ categoria.id }}" >{{categoria.nombre}}</h2>
  <hr>
  <br>
  {% for subcategoria in categoria.subcategorias.all %}
  <h4>{{subcategoria.nombre}}</h4>
  <br>
  <div class="container">
    <div class="row row-cols-sm-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4">
      {% for platillo in subcategoria.platillos.all %}
      <div class="col text-center">
        <div
          class="card py-2 "
          style="width: 18rem;" >
          <div class="card-header">
            <h5
              id="platillo-{{ platillo.id }}-nombre">
              {{ platillo.nombre }}
            </h5>
          </div>
          <img
            id="platillo-{{ platillo.id }}-imagen"
            onclick="loadModalDetails( {{ platillo.id }} )"
            data-bs-toggle="modal"
            data-bs-target="#globalModal"
            src="{{ platillo.imagen }}"
            class="card-img-top"
            alt="{{ platillo.imagen }}">
          <div class="card-body">
            <h5
              id="platillo-{{ platillo.id }}-precio"
              class="card-title pricing-card-title text-muted {{ platillo.line_through_if_helado }}">
              $ {{ platillo.precio }}
            </h5>
            {% if platillo.descripcion %}
              <p
                id="platillo-{{ platillo.id }}-descripcion"
                class="card-text text-muted" hidden>
                {{ platillo.descripcion }}
              </p>
            {% endif %}
          </div>
          {% if platillo.get_ingredientes_list %}
          <ul
            id="platillo-{{ platillo.id }}-ingredientes"
            class="list-group list-group-flush" hidden>
            {% for ingrediente in platillo.get_ingredientes_list %}
              <li class="list-group-item text-muted">{{ ingrediente }}</li>
            {% endfor %}
          </ul>
          {% endif %}
          <div
            {{ platillo.hidden_if_helado }}
            class="card-body">
            <div class="d-grid gap-2">
              <div
                class="btn-group"
                role="group"
                aria-label="Basic mixed styles example">
                <button
                  {{ platillo.disabled_if_helado }}
                  onclick="decrementCount({{ platillo.id }})"
                  type="button"
                  class="btn btn-primary">
                  <i class="bi bi-dash"></i>
                </button>
                <button
                  id="counter{{platillo.id}}"
                  type="button"
                  class="btn btn-outline-primary"
                  disabled
                  />1</button>
                <button
                  {{ platillo.disabled_if_helado }}
                  onclick="incrementCount({{ platillo.id }})"
                  type="button"
                  class="btn btn-primary">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
          </div>
          <div
            {{ platillo.hidden_if_helado }}
            class="card-footer text-muted">
            <div class="d-grid gap-2">
              <button
                {{ platillo.disabled_if_helado }}
                class="btn btn-primary"
                onclick="agregarAlCarrito({{ platillo.id }})"
                class="card-link">
                <i class="bi bi-cart-plus"></i>&nbsp;
                Agregar al carrito
              </button>
            </div>
          </div>
        </div>
        <br>
      </div>
      <br>
      {% endfor %}

      <br>
    </div>

    <br>
  </div>
  <br>
  {% endfor %}
  <a href="#breadcrumb" class="text-decoration-none float-end rounded-circle">
    <i class="bi bi-arrow-up"></i>
  </a>
  <br>
{% endfor %}
{% endblock %}







{% block scripts %}
<script>

function loadModalDetails(platilloId) {
  let precio = $(`#platillo-${platilloId}-precio`)
    .text()
    .trim();
  let nombre = $(`#platillo-${platilloId}-nombre`)
    .text()
    .trim();
  let descripcion = $(`#platillo-${platilloId}-descripcion`)
    .text()
    .trim();
  let imagen = $(`#platillo-${platilloId}-imagen`).attr('src');
  let ingredientes = $(`#platillo-${platilloId}-ingredientes`)
    .text()
    .trim();
  // let alergenos = $(`#platillo-${platilloId}-alergenos`)
    // .html();

  $('#platilloPrecio').text(precio ? precio : '');
  $('#tituloModal').html(nombre ? nombre : '');
  $('#platilloIngredientes').html(ingredientes ? ingredientes : '');
  //$('#platilloAlergenos').html(alergenos ? alergenos : '');
  $('#platilloDescripcion').html(descripcion ? descripcion : '');
  $('#platilloImagen').attr('src', imagen ? imagen : '');

}

/**
 * Función que incrementa en uno la cantidad de elementos a agregar
 * al carrito del platillo especificado.¨
 *
 * @param {number} identificador del platillo.
*/
function incrementCount(platilloId) {
  let count = parseInt($('#counter' + platilloId).text());
  $('#counter' + platilloId).text(count + 1);
}

/**
 * Función que decrementa en uno la cantidad de elementos a agregar
 * al carrito del platillo especificado, sólo si la cuenta es mayor que 1.
 *
 * @param {number} identificador del platillo.
*/
function decrementCount(platilloId) {
  let count = parseInt($('#counter' + platilloId).text());
  if (count > 1)
    $('#counter' + platilloId).text(count - 1);
}

/**
 * Función que agrega un pedido al carrito.
 *
 * @param {number} identificador del platillo.
*/
function agregarAlCarrito(platilloId) {
  $.ajax("{% url 'mainApp:carrito' %}",{
    type: 'PUT',
    contentType: 'application/json',
    data: {
      platillo: parseInt(platilloId),
      cantidad: parseInt($('#counter' + platilloId).text())
    },
    success: function(res) {
      window.location.href = '{% url 'mainApp:carrito' %}'
    },
    error: function(err) {
      console.error(err);
    }
  });
}

</script>
{% endblock %}
